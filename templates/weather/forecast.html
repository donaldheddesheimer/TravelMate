{% extends 'base.html' %}
{% load static %}

{% block title %}{{ trip.destination }} Weather - TravelMate{% endblock %}

{% block content %}
<div class="weather-wrapper">
  <div class="weather-container">
    <div class="weather-header">
      <h1>Weather for {{ trip.destination }}</h1>
      <p>{{ trip.date_leaving|date:"M d, Y" }} to {{ trip.date_returning|date:"M d, Y" }}</p>
      <a href="{% url 'trips:dashboard' trip.id %}" class="back-link">
        ← Back to Dashboard
      </a>
    </div>

    <div class="weather-content">
      <div id="weather-data">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading weather data...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get data needed for the API call
    const city = "{{ trip.destination|escapejs }}"; // Use escapejs for safety
    const startDate = "{{ trip.date_leaving|date:'Y-m-d' }}"; // Format YYYY-MM-DD
    const endDate = "{{ trip.date_returning|date:'Y-m-d' }}";   // Format YYYY-MM-DD

    // Construct the API URL using the parameters expected by get_weather_view
    // Ensure this path matches your urls.py for the get_weather_view
    const apiUrl = `/weather/api/weather/?city=${encodeURIComponent(city)}&start_date=${encodeURIComponent(startDate)}&end_date=${encodeURIComponent(endDate)}`;

    console.log("Fetching weather from:", apiUrl);

    fetch(apiUrl)
        .then(response => {
            if (!response.ok) {
                 // Try to get error message from JSON response body
                return response.json().then(errData => {
                    throw new Error(errData.error || `HTTP error! status: ${response.status}`);
                }).catch(() => {
                    // If response is not JSON or parsing fails, throw generic error
                     throw new Error(`HTTP error! status: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(weatherData => {
            console.log("Received weather data:", weatherData);
            const weatherDiv = document.getElementById('weather-data');

            if (weatherData.error) {
                throw new Error(weatherData.error);
            }

            if (!weatherData.list || weatherData.list.length === 0) {
                weatherDiv.innerHTML = `
                    <div class="current-weather">
                        <h2>${weatherData.city?.name || city}</h2>
                        <p>No forecast data available for the selected dates.</p>
                    </div>`;
                return;
            }

            // Group by day (using UTC date string for grouping)
            const dailyForecast = {};
            weatherData.list.forEach(item => {
                const dateKey = new Date(item.dt * 1000).toISOString().split('T')[0]; // Group by YYYY-MM-DD (UTC)

                if (!dailyForecast[dateKey]) {
                    dailyForecast[dateKey] = {
                        // Display date in local, more readable format
                        displayDate: new Date(item.dt * 1000).toLocaleDateString('en-US', {
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric'
                        }),
                        items: [],
                        maxTemp: -Infinity, // Initialize for finding max
                        minTemp: Infinity,  // Initialize for finding min
                        icons: new Set(), // Use a Set to store unique icons for the day
                        descriptions: new Set() // Use a Set for unique descriptions
                    };
                }
                dailyForecast[dateKey].items.push(item);
                dailyForecast[dateKey].maxTemp = Math.max(dailyForecast[dateKey].maxTemp, item.main.temp_max);
                dailyForecast[dateKey].minTemp = Math.min(dailyForecast[dateKey].minTemp, item.main.temp_min);
                dailyForecast[dateKey].icons.add(item.weather[0].icon);
                dailyForecast[dateKey].descriptions.add(item.weather[0].description);
            });

            // Display forecast
            weatherDiv.innerHTML = `
                <div class="current-weather">
                    <h2>${weatherData.city.name}</h2>
                    <p>Trip Duration: ${weatherData.trip_duration} days</p>
                     <p>Forecast for ${Object.keys(dailyForecast).length} day(s)</p>
                </div>
                <div class="forecast-header">
                    <h3>Daily Forecast</h3>
                </div>
                <div class="daily-forecast">
                    ${Object.values(dailyForecast).map(day => {
                        // Pick a representative icon (e.g., the first one)
                        const representativeIcon = day.icons.values().next().value || '01d'; // Default if empty
                        const representativeDesc = [...day.descriptions].join(', '); // Combine descriptions

                        return `
                        <div class="forecast-day">
                            <p class="forecast-date">${day.displayDate}</p>
                            <img src="https://openweathermap.org/img/wn/${representativeIcon}@2x.png" alt="${representativeDesc}">
                            <p class="forecast-temp">
                                ${Math.round(day.maxTemp)}°C / ${Math.round(day.minTemp)}°C
                            </p>
                            <p class="forecast-desc">${representativeDesc}</p>
                            <details class="hourly-details">
                                <summary>Hourly</summary>
                                <div class="hourly-forecast">
                                    ${day.items.map(item => `
                                        <div class="hourly-item">
                                            <p>${new Date(item.dt * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false})}</p>
                                            <img src="https://openweathermap.org/img/wn/${item.weather[0].icon}.png" alt="${item.weather[0].description}">
                                            <p>${Math.round(item.main.temp)}°C</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        </div>
                    `}).join('')}
                </div>
            `;
        })
        .catch(error => {
            console.error('Error fetching or processing weather data:', error);
            document.getElementById('weather-data').innerHTML = `
                <div class="weather-error">
                    <h2>Error</h2>
                    <p>Could not load weather data for ${city}.</p>
                    <p><i>${error.message}</i></p>
                    <p>Please check the city name and ensure the API service is available.</p>
                </div>
            `;
        });
});
</script>

<style>
/* General styles */
.weather-wrapper {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 0 1rem;
    color: white; /* Default text color */
}

.weather-container {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.weather-header {
    text-align: center;
    margin-bottom: 2rem;
}

.weather-header h1 {
    font-size: 2.2rem;
    margin-bottom: 0.5rem;
}

.weather-header p {
    color: rgba(255, 255, 255, 0.8);
}

.back-link {
    display: inline-block;
    margin-top: 1rem;
    color: var(--color-primary);
    text-decoration: none;
    transition: color 0.3s ease;
}

.back-link:hover {
    color: #ff5e41; /* Slightly different hover color */
}

/* Current Weather / Summary Box */
.current-weather {
    background: rgba(255, 255, 255, 0.08);
    padding: 1.5rem 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    border-left: 4px solid var(--color-primary);
}

.current-weather h2 {
    margin: 0 0 0.5rem 0;
    font-size: 1.8rem;
    color: var(--color-primary);
}

.current-weather p {
    margin: 0.3rem 0;
    color: rgba(255, 255, 255, 0.9);
}

/* Forecast Header */
.forecast-header {
    margin: 2rem 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.forecast-header h3 {
    font-size: 1.5rem;
    font-weight: 600;
}

/* Daily Forecast Grid */
.daily-forecast {
    display: grid;
    gap: 1.5rem;
    /* Adjust columns: more space, fewer columns on smaller screens */
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
}

/* Individual Forecast Day Card */
.forecast-day {
    background: rgba(255, 255, 255, 0.05);
    padding: 1.2rem;
    border-radius: 8px;
    text-align: center;
    transition: background 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
}

.forecast-day:hover {
    background: rgba(255, 255, 255, 0.1);
}

.forecast-date {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.forecast-day img {
    width: 60px; /* Slightly larger icon */
    height: 60px;
    margin: 0.5rem auto;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

.forecast-temp {
    margin: 0.5rem 0;
    font-size: 1.1rem;
    font-weight: 500;
}

.forecast-desc {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    text-transform: capitalize;
    margin-bottom: 1rem;
    min-height: 2.5em; /* Allow space for multiple descriptions */
}

/* Hourly Forecast Details */
.hourly-details {
    margin-top: auto; /* Push details/summary to the bottom */
}

.hourly-details summary {
    cursor: pointer;
    font-weight: 500;
    color: var(--color-primary);
    padding: 0.3rem 0;
    border-radius: 4px;
    transition: background 0.2s;
    display: inline-block; /* Allow centering */
}

.hourly-details summary:hover {
    text-decoration: underline;
}

.hourly-forecast {
    display: flex;
    gap: 1rem; /* Increased gap */
    margin-top: 0.8rem;
    overflow-x: auto; /* Enable horizontal scroll */
    padding: 0.5rem 0.2rem 0.8rem 0.2rem; /* Add padding for scrollbar */
    /* Custom scrollbar styles (optional) */
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
}
/* Webkit scrollbar styles */
.hourly-forecast::-webkit-scrollbar {
  height: 6px;
}
.hourly-forecast::-webkit-scrollbar-track {
  background: transparent;
}
.hourly-forecast::-webkit-scrollbar-thumb {
  background-color: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
}


.hourly-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 65px; /* Wider items */
    font-size: 0.8rem;
    text-align: center;
    background: rgba(0, 0, 0, 0.1); /* Slight background for items */
    padding: 0.5rem;
    border-radius: 6px;
}

.hourly-item p {
    margin: 0.1rem 0;
}

.hourly-item img {
    width: 35px; /* Slightly larger hourly icon */
    height: 35px;
    margin: 0.2rem auto;
}

/* Loading Spinner */
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    min-height: 200px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.2); /* Adjusted border */
    border-radius: 50%;
    border-top-color: var(--color-primary);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 1rem;
}

.loading-spinner p {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
}

/* Error Message Styling */
.weather-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    text-align: center;
    background: rgba(255, 107, 107, 0.1); /* Light red background */
    border: 1px solid rgba(255, 107, 107, 0.3); /* Light red border */
    border-radius: 12px;
    color: #ffcbcb; /* Lighter red text */
}

.weather-error h2 {
    color: #ff6b6b; /* Stronger red for title */
    margin-bottom: 1rem;
}
.weather-error p {
    margin: 0.3rem 0;
}
.weather-error i {
    color: rgba(255, 204, 204, 0.8); /* Softer color for error message detail */
}


@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .daily-forecast {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1rem;
    }
    .weather-container {
        padding: 1.5rem;
    }
}

@media (max-width: 480px) {
    .daily-forecast {
        /* Stack days vertically on very small screens */
        grid-template-columns: 1fr;
    }
     .weather-header h1 {
        font-size: 1.8rem;
    }
    .current-weather {
        padding: 1rem 1.5rem;
    }
    .current-weather h2 {
        font-size: 1.5rem;
    }
    .forecast-day {
        padding: 1rem;
    }
    .hourly-item {
        min-width: 60px;
    }
}
</style>
{% endblock %}