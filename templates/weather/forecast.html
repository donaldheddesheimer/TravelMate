{% extends 'base.html' %}
{% load static %}

{% block title %}{{ trip.destination }} Weather - TravelMate{% endblock %}

{% block content %}
<div class="weather-wrapper">
  <div class="weather-container">
    <div class="weather-header">
      <h1>Weather for {{ trip.destination }}</h1>
      <p>{{ trip.date_leaving|date:"M d, Y" }} to {{ trip.date_returning|date:"M d, Y" }}</p>
      <a href="{% url 'trips:dashboard' trip.id %}" class="back-link">
        ← Back to Dashboard
      </a>
    </div>

    <div class="weather-content">
      <div id="weather-data">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading weather forecast...</p>
        </div>
      </div>
      <div id="last-updated" class="last-updated"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing weather forecast...');
    
    let lastUpdateTime = null;
    let updateInterval = null;
    
    // Function to format time
    function formatTime(date) {
        return date.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        });
    }

    // Function to update the last updated timestamp
    function updateTimestamp() {
        const now = new Date();
        const nextUpdate = new Date(now.getTime() + 60 * 60 * 1000); // 1 hour from now
        
        const lastUpdatedDiv = document.getElementById('last-updated');
        lastUpdatedDiv.innerHTML = `
            <p>Last updated: ${formatTime(now)}</p>
            <p>Next update: ${formatTime(nextUpdate)}</p>
        `;
        
        lastUpdateTime = now;
        console.log(`Updated timestamp: ${formatTime(now)}, Next update: ${formatTime(nextUpdate)}`);
    }
    
    // Function to fetch weather data
    function fetchWeatherData() {
        console.log('Fetching weather data...');
        const loadingDiv = document.getElementById('weather-data');
        loadingDiv.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Loading weather forecast...</p>
            </div>
        `;
        
        const url = `/api/weather/?destination={{ trip.destination }}&start_date={{ trip.date_leaving|date:"Y-m-d" }}&end_date={{ trip.date_returning|date:"Y-m-d" }}`;
        console.log(`Making request to: ${url}`);
        
        fetch(url)
            .then(response => {
                console.log(`Response status: ${response.status}`);
                if (!response.ok) {
                    console.error('Response not OK:', response.status, response.statusText);
                    throw new Error('Failed to get weather forecast');
                }
                return response.json();
            })
            .then(weatherData => {
                console.log('Weather data received:', weatherData);
                if (!weatherData.error) {
                    const weatherDiv = document.getElementById('weather-data');
                    
                    // Create current weather section
                    const currentDay = weatherData.forecast[0];
                    const currentWeather = `
                        <div class="current-weather">
                            <div class="weather-main">
                                <div class="weather-icon-temp">
                                    <img src="https://openweathermap.org/img/wn/${currentDay.icon}@2x.png" alt="${currentDay.conditions}" onerror="this.src='https://openweathermap.org/img/wn/01d@2x.png'">
                                    <div class="temperature">${Math.round(currentDay.high_temp)}°F</div>
                                </div>
                                <div class="weather-details">
                                    <h2>{{ trip.destination }}</h2>
                                    <p class="weather-condition">${currentDay.conditions}</p>
                                    <div class="weather-stats">
                                        <span class="weather-temp-range">High: ${Math.round(currentDay.high_temp)}°F / Low: ${Math.round(currentDay.low_temp)}°F</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Create forecast section
                    const forecastSection = `
                        <div class="forecast-section">
                            <h3>Forecast for Your Trip</h3>
                            <div class="forecast-grid">
                                ${weatherData.forecast.map(day => {
                                    const date = new Date(day.date);
                                    date.setDate(date.getDate() + 1);
                                    const formattedDate = date.toLocaleDateString('en-US', {
                                        weekday: 'short',
                                        month: 'short',
                                        day: 'numeric'
                                    });
                                    return `
                                    <div class="forecast-day">
                                        <p class="forecast-date">${formattedDate}</p>
                                        <img src="https://openweathermap.org/img/wn/${day.icon}@2x.png" alt="${day.conditions}" onerror="this.src='https://openweathermap.org/img/wn/01d@2x.png'">
                                        <div class="forecast-temps">
                                            <span class="high-temp">${Math.round(day.high_temp)}°F</span>
                                            <span class="low-temp">${Math.round(day.low_temp)}°F</span>
                                        </div>
                                        <p class="forecast-conditions">${day.conditions}</p>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;

                    weatherDiv.innerHTML = currentWeather + forecastSection;
                    updateTimestamp();
                    console.log('Weather data displayed successfully');
                } else {
                    console.error('Weather data error:', weatherData.error);
                    throw new Error(weatherData.error);
                }
            })
            .catch(error => {
                console.error('Error loading weather forecast:', error);
                document.getElementById('weather-data').innerHTML = `
                    <div class="weather-error">
                        <p>Error loading weather forecast</p>
                        <p>${error.message}</p>
                        <p>Please try refreshing the page.</p>
                    </div>
                `;
            });
    }
    
    // Initial fetch
    fetchWeatherData();
    
    // Set up interval to check for updates
    updateInterval = setInterval(() => {
        const now = new Date();
        if (lastUpdateTime && (now - lastUpdateTime) >= 60000) { // 1 minute
            console.log('One minute has passed, refreshing weather data...');
            fetchWeatherData();
        }
    }, 1000); // Check every second
    
    // Clean up interval on page unload
    window.addEventListener('beforeunload', () => {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
});
</script>

<style>
.weather-wrapper {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.weather-container {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.weather-header {
    text-align: center;
    margin-bottom: 2rem;
}

.weather-header h1 {
    font-size: 2.2rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.weather-header p {
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.8);
}

.back-link {
    display: inline-block;
    margin-top: 1rem;
    color: var(--color-primary);
    text-decoration: none;
    transition: color 0.3s ease;
}

.back-link:hover {
    color: #ff5e41;
}

.current-weather {
    background: rgba(255, 255, 255, 0.08);
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.weather-main {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.weather-icon-temp {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.weather-icon-temp img {
    width: 80px;
    height: 80px;
}

.temperature {
    font-size: 3rem;
    font-weight: 700;
}

.weather-details {
    flex: 1;
}

.weather-details h2 {
    margin: 0 0 0.5rem 0;
    font-size: 1.8rem;
}

.weather-condition {
    text-transform: capitalize;
    font-size: 1.2rem;
    margin: 0 0 1rem 0;
    color: rgba(255, 255, 255, 0.8);
}

.weather-stats {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.7);
}

.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    border-top-color: var(--color-primary);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 1rem;
}

.weather-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    text-align: center;
    color: #ff6b6b;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .weather-main {
        flex-direction: column;
        text-align: center;
    }

    .weather-icon-temp {
        justify-content: center;
    }

    .temperature {
        font-size: 2.5rem;
    }

    .weather-details h2 {
        font-size: 1.5rem;
    }
}

.weather-temp-range {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
}

.forecast-section {
    background: rgba(255, 255, 255, 0.08);
    padding: 2rem;
    border-radius: 12px;
    margin-top: 2rem;
}

.forecast-section h3 {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    color: var(--color-primary);
}

.forecast-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.forecast-day {
    background: rgba(255, 255, 255, 0.05);
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    transition: transform 0.3s ease;
}

.forecast-day:hover {
    transform: translateY(-5px);
    background: rgba(255, 255, 255, 0.1);
}

.forecast-date {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--color-primary);
}

.forecast-day img {
    width: 50px;
    height: 50px;
    margin: 0.5rem auto;
}

.forecast-temps {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin: 0.5rem 0;
}

.high-temp {
    font-weight: 600;
    color: #ff6b6b;
}

.low-temp {
    color: rgba(255, 255, 255, 0.7);
}

.forecast-conditions {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 0.5rem;
}

@media (max-width: 768px) {
    .forecast-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
}

.last-updated {
    text-align: center;
    margin-top: 1rem;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
}

.last-updated p {
    margin: 0.25rem 0;
}
</style>
{% endblock %}